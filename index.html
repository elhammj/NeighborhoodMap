<!-- 
	Name: Elham Jaffar
	Date: Starting 10/10/2017 To 15/10/2017
	Project Name: Neighborhood Map
	Project File: index.html
	Project Main Purpose: A single-page application featuring a map of my neighborhood
	Technologies: Google APIs, Knockout Framework 
	Resources:
		Map Style: 
		(1) https://mapstyle.withgoogle.com
		General Style: 
		(1) https://stackoverflow.com/questions/11232627/perfect-100-width-of-parent-container-for-a-bootstrap-input
		(2) https://stackoverflow.com/questions/13056207/textbox-css-hover-focus
		(3) https://getbootstrap.com/docs/4.0/components/navbar/
		(4) https://developers.google.com/maps/documentation/javascript/examples/control-positioning
		Error Solutions: 
		(1) https://stackoverflow.com/questions/40489808/knockout-click-binding-with-parameters
		(2) http://knockoutjs.com/documentation/click-binding.html
		(3) http://knockoutjs.com/documentation/textinput-binding.html
-->
<!DOCTYPE html>
<html>
  <head>
  	<!-- To make sure the browser support the character -->
	<meta charset=“utf-8”> 
	<!-- To support the browsers (Internet Explorer) -->
	<meta http-equiv=“X-UA-Compatible” content=“IE=edge”> 
	<!-- To support mobile version and responsive --> 
	<meta name=“viewpoint” content=“width=device-width, initial-scale=1”>
	<!-- Link style sheet bootstrap for resposive design -->
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<title> Neighborhood Map Project </title>
  </head>
  <body>
  	<!--View Part: including HTML and Data bind attribute
		Navigation Part As a heading, from bootstrap documentation -->
	<nav class="nav navbar-default navbar-fixed-top">
		<div class="navbar-header">
				<span id="subject" class="navbar-brand mb-0">Philadelphia Universities and Libraries</span>
		</div>
				<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
	</nav>
  	<div class="container-fluid">
	  	<div class="row" id="all">
	  		<!-- side bar -->
	  		<div class="col-md-3">
		  		<div class="side-list text-md-center" id="sidebar">
		  			<div class="row">
		  				<div class="col-md-12">
							<input type="text" id="textToFilter" data-bind="value: filter, valueUpdate: 'afterkeydown'" class="form-control" placeholder="type text to filter the list">
						</div>
		  			</div>
		  			<ul class="list-group" data-bind="foreach: filteredList">
		  				<p data-bind="text: title, click: $parent.locationClicked"></p>
		  			</ul>
	  			</div>
	  		</div>
	  		<!-- Map Div -->
	  		<div class="col-md-9" id="mapCol">
				<div id="map">
				</div>
			</div>
		</div>
	</div>
	<!-- Java script part -->
	<script>
		/*
			Model part: including objects of location, style and etc
		*/

		/* 
			Variables: (1) style the map, (2) add locaitons info as array of objects, (3) default icon for map pin (4) decleare infowindow 
		*/
		var map;
		var mapStyle = [
		  {
		    "elementType": "geometry",
		    "stylers": [
		      {
		        "color": "#242f3e"
		      }
		    ]
		  },
		  {
		    "elementType": "geometry.fill",
		    "stylers": [
		      {
		        "color": "#4b5c62"
		      }
		    ]
		  },
		  {
		    "elementType": "labels.text",
		    "stylers": [
		      {
		        "color": "#ffffff"
		      }
		    ]
		  },
		  {
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#746855"
		      }
		    ]
		  },
		  {
		    "elementType": "labels.text.stroke",
		    "stylers": [
		      {
		        "color": "#242f3e"
		      }
		    ]
		  },
		  {
		    "featureType": "administrative.locality",
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#d59563"
		      }
		    ]
		  },
		  {
		    "featureType": "poi",
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#d59563"
		      }
		    ]
		  },
		  {
		    "featureType": "poi.attraction",
		    "elementType": "geometry",
		    "stylers": [
		      {
		        "weight": 1.5
		      }
		    ]
		  },
		  {
		    "featureType": "poi.park",
		    "elementType": "geometry",
		    "stylers": [
		      {
		        "color": "#263c3f"
		      }
		    ]
		  },
		  {
		    "featureType": "poi.park",
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#6b9a76"
		      }
		    ]
		  },
		  {
		    "featureType": "road",
		    "elementType": "geometry",
		    "stylers": [
		      {
		        "color": "#38414e"
		      }
		    ]
		  },
		  {
		    "featureType": "road",
		    "elementType": "geometry.stroke",
		    "stylers": [
		      {
		        "color": "#212a37"
		      }
		    ]
		  },
		  {
		    "featureType": "road",
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#9ca5b3"
		      }
		    ]
		  },
		  {
		    "featureType": "road.arterial",
		    "elementType": "geometry.fill",
		    "stylers": [
		      {
		        "color": "#929292"
		      }
		    ]
		  },
		  {
		    "featureType": "road.highway",
		    "elementType": "geometry",
		    "stylers": [
		      {
		        "color": "#746855"
		      }
		    ]
		  },
		  {
		    "featureType": "road.highway",
		    "elementType": "geometry.stroke",
		    "stylers": [
		      {
		        "color": "#1f2835"
		      }
		    ]
		  },
		  {
		    "featureType": "road.highway",
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#f3d19c"
		      }
		    ]
		  },
		  {
		    "featureType": "road.local",
		    "elementType": "geometry.fill",
		    "stylers": [
		      {
		        "color": "#ffffff"
		      }
		    ]
		  },
		  {
		    "featureType": "transit",
		    "elementType": "geometry",
		    "stylers": [
		      {
		        "color": "#2f3948"
		      }
		    ]
		  },
		  {
		    "featureType": "transit.line",
		    "elementType": "geometry.stroke",
		    "stylers": [
		      {
		        "color": "#d59563"
		      }
		    ]
		  },
		  {
		    "featureType": "transit.station",
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#d59563"
		      }
		    ]
		  },
		  {
		    "featureType": "water",
		    "elementType": "geometry",
		    "stylers": [
		      {
		        "color": "#17263c"
		      }
		    ]
		  },
		  {
		    "featureType": "water",
		    "elementType": "labels.text.fill",
		    "stylers": [
		      {
		        "color": "#515c6d"
		      }
		    ]
		  },
		  {
		    "featureType": "water",
		    "elementType": "labels.text.stroke",
		    "stylers": [
		      {
		        "color": "#17263c"
		      }
		    ]
		  }
		]; 
    	var locations = [
    			{
	    			location:{lat: 39.956623, lng: -75.189933},
					title:'Drexel University',
					address:'Lancaster Walk, Philadelphia, PA 19104, USA'
				},
		        {
			        location:{lat: 39.952220, lng: -75.193204},
			    	title:'University of Pennsylvania',
					address:'3405 Woodland Walk, Philadelphia, PA 19104, USA'
				},
		        {
		        	location:{lat: 39.948890, lng: -75.155950},
		    		title:'Jefferson University',
					address:'130 S 9th St, Philadelphia, PA 19107, USA'
				},
		        {
		        	location: {lat: 39.946821, lng: -75.207095},
		    		title:'University of the Sciences in Philadelphia',
					address:'4217-4231 Woodland Ave, Philadelphia, PA 19104, USA'
				},
		        {
		        	location: {lat: 40.005195, lng: -75.216562},
		    		title:'Philadelphia College of Osteopathic Medicine',
					address:'Evans Hall, Philadelphia, PA 19131, USA'
				},
				{

		        	location: {lat: 39.994996, lng: -75.240123},
		    		title:'Saint Joseph\'s University',
					address:'5600 City Ave, Philadelphia, PA 19131, USA'
				},
				{
					location: {lat: 39.981194, lng: -75.155353},
					title: 'Temple University',
					address: '1801 N Broad St, Philadelphia, PA 19122, USA'
				},
				{
					location: {lat: 40.038608, lng: -75.156632},
					title: 'La Salle University',
					address: 'Logan/ Ogontz/ Fern Rock, Philadelphia, PA, USA'
				},
				{
					location: {lat: 39.994346, lng: -75.238518},
					title: 'Francis A. Drexel Library',
					address: '5500 Rural Ln, Philadelphia, PA 19131, USA'
				}
		];
		var iconUrl = 'https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|FF7E72';
		var infoWindow;



		/*
			initMap(): This function to initialize the map and give a center point
			Also, add controls like zoom, street view and scale
		*/
		function initMap() {
				
				map = new google.maps.Map(document.getElementById('map'), {
		          center: locations[6].location,
		          zoom: 12,
		          styles: mapStyle,
		          mapTypeControl: true,
			      mapTypeControlOptions: {
			          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
			          position: google.maps.ControlPosition.TOP_CENTER
			      },
			      zoomControl: true,
			      zoomControlOptions: {
			          position: google.maps.ControlPosition.LEFT_CENTER
			      },
			      scaleControl: true,
			      streetViewControl: true,
			      streetViewControlOptions: {
			          position: google.maps.ControlPosition.LEFT_TOP
			      },
			      fullscreenControl: true
		        });

		        this.AddMarker(); //To add marker to each location as a key and value
		        ko.applyBindings(new LocationsViewModel()); //Binding the view model 
		}
		    

		/*
			Viewmodel part: functions to update the list view and markers
			LocationsViewModel(): crete marker and put a list data as an observable array
			Functions:
			(1) filter the list of lcoations and marker synchronously 
			(2) animate the marker and show the infowindow when one of the list item is clicked
		*/
		var LocationsViewModel = function () {
			var self = this;
		    self.viewLocations = ko.observableArray(locations);
		    //bind filter to filter text
  			self.filter = ko.observable();
  			//For currentSelected
  			self.currentSelected = ko.observable();
  			
			  //Use filteredList to get the updated list
			  self.filteredList = ko.computed(function () {
			    var copyArr = [];
			    var filter = self.filter();
			    if (filter) {
			    	//Filter the list
			        ko.utils.arrayForEach(self.viewLocations(), function (element) {
			        	var currentTitle = element.title.toLowerCase();
			        	var currentText = filter.toLowerCase();
			        	//Search allows the user to find a locaiton that contains this keyword
			            if (currentTitle.indexOf(currentText) !== -1) { 
			                copyArr.push(element);
			                element.marker.setVisible(true);
			            }
			            else{
			            	element.marker.setVisible(false);//set false to hide the marker during filtering 
			            }
			        });
			    } 
			    else {
			        copyArr = self.viewLocations(); //Return the regular markers and locations
					 ko.utils.arrayForEach(self.viewLocations(), function (element) {
					 	element.marker.setVisible(true);
		      		 });
			    } 
			    //Indicate which title has been selected and show infowwindow with animating the marker by calling AddAnimation function 
			    self.locationClicked = function(element) {
			    	if (element.marker.getAnimation() != null) {
			            element.marker.setAnimation(null);
			        } else {
			        	map.panTo(element.marker.position); //Zoom to the current marker, when it is clicked  
			  			AddInfo(element.marker, infoWindow);
			  			AddAnimation(element.marker,"FFFFFF");
			  		}
			  	}
			    return copyArr;
			}); 
		}

		
		/*
			AddMarker(): It is a function to to create a marker, animate a marker when it is clicked and show a custom infowindow by calling AddAnimation and AddInfo functions. 
		*/
		var AddMarker = function() {

			//create infoWindow and set a max width
					infoWindow = new google.maps.InfoWindow({
				maxWidth: 200
			});

	        // Get the position and title from the location array.
	       	for (var i=0; i< locations.length; i++)
	       	{
	       		var position = locations[i].location;
	       		var title = locations[i].title;
	       		var formatAddress = locations[i].address;
	          	var marker = new google.maps.Marker({
	          	position:position, 
	          	map: map, 
	          	address: formatAddress,
	          	title:title, 
	          	visible: true,
	          	icon: iconUrl });
	        
	         
	         //Action when the user click on a pin, animate and chcnage hte color by calling AddInfo and AddAnimation functions
	         marker.addListener('click', (function(marker) {
				    return function() {
				    	map.panTo(marker.position); //Zoom to the current marker, when it is clicked   
				    	AddAnimation(marker,"FFDF4C");
				        AddInfo(marker, infoWindow); 
				    }
				})(marker));
				     locations[i].marker = marker; //Add a marker to the locaiton object as an attribute
			}}


			/*
				API Part To Add Info To Infowidow
				ADDInfo: It is a function to add a descreption to the marker's infowindow
				I got the idea about how to set the content from wikipedia (https://github.com/erikaleigh/udacity-neighbourhood-map/blob/master/js/map.js) 
				However; I have wrttien the cod efrom my understanding and implemted to work with my other functions

			*/
		function AddInfo(marker, infoWindow){	
			//Here is the link, we just pass the marker title	        	
        	var wikiUrl = 'https://en.wikipedia.org/w/api.php?action=opensearch&search=' + marker.title  + '&format=json&callback=wikiCallback';
        		         	

        	//Ajax request to retreive data from wikipedia page
        	$.ajax({
        		url: wikiUrl,
        		dataType: "jsonp" }).success(function(response) {

				        var wikiLocURL = response[3][0]; //To get first url
				        var wikiContent = response[2][0]; //To get a first part of the chosen url
				        //Wikipedia API returns undefined 
				        if (wikiLocURL === undefined) {
				          infoWindow.setContent('<div id="info">' + '<h6>' + marker.title + '</h6></br>' + '<h8>' + marker.address + '</h8> </br></br> <p>' + '*** No Wikipedia data for this location ***' + '</p> </br> <a href="https://en.wikipedia.org/wiki/Main_Page" target="blank">' + 'Visit Wikipedia to Search' + '</a> </p> </div>');
				        } else { //when it is successful and data returned
				          infoWindow.marker = marker;
				          infoWindow.setContent('<div id="info">' + '<h6>' + marker.title + '</h6></br>' + '<h8>' + marker.address + '</h8> </br> </br> <p>' + wikiContent + "...." + '</p> </br> <a href="' + wikiLocURL + '" target="blank">' + 'Visit Wikipedia to Read More' + '</a> </p> </div>');
				     	}
				        infoWindow.open(map, marker);
				        //When Wikipedia Return 
				      }).error(function() {
				        infoWindow.setContent('<div id="info">' + '<h6>' + marker.title + '</h6></br>' + '<h8>' + marker.address + '</h8> </br> </br> <p>' + '*** Error while retreving wikipedia data ***' + '</p> </br> <a href=href="https://en.wikipedia.org/wiki/Main_Page" target="blank">' + 'Visit Wikipedia' + '</a> </p> </div>');
				        infoWindow.open(map, marker);
				})
	    }

		/*
			AddAnimation: It is a function to add a animation and change color when the it is called
		*/

	    function AddAnimation(marker,color){
	    	 if (marker.getAnimation() != null) {
		            marker.setAnimation(null);
			        } else {
			        	marker.setAnimation(google.maps.Animation.BOUNCE);
		           		marker.setIcon('https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|' + color);
			            setTimeout(function () {
						    marker.setAnimation(null);
						    marker.setIcon(iconUrl);
						}, 700);
			        }
	    }
			

		/*
			handleError: It is a function to handle google map error
		*/
		function handleError(){
			alert("There is a problem in loading google map, try gaian !");
		}

   </script>
   <!-- Link the google map and use its library: Google API Key -->
   <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvayfCRVy51r31KqhPbFoEu-tyHwznHc0&v=3&callback=initMap&onerror=handleError"></script>
   <!-- link bootstrap javascript -->
	<script async type="javascript" src="js/bootstrap.min.js"></script>
	<!-- link jQuery javascript -->
	<script async src="js/jQuery.js"></script>
   <!-- Link Knockout Framework -->
	<script async type="text/javascript" src="js/knockout-3.4.2.js"></script>
    <!--Use webfont loader to load the font faster-->
	<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
	<script>
	 WebFont.load({
	    google: {
	      families: ['Oswald']
	    }
	  });
	</script>
 </body>
</html>
		   